<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JORFOR MAP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* 1ç”»é¢ã«åã‚ã‚‹ãŸã‚ã®åŸºæœ¬è¨­å®š */
        html, body { 
            height: 100vh; 
            width: 100vw;
            margin: 0; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            font-family: sans-serif;
            background-color: #f0f7f9;
            transition: background-color 0.3s ease;
        }
        
        header { background: #fff; padding: 10px; text-align: center; flex-shrink: 0; border-bottom: 1px solid #eee; z-index: 1000; }
        h1 { margin: 0; font-size: 1.1rem; color: #333; }

        .mode-switcher { display: flex; padding: 10px; background: #fff; gap: 10px; flex-shrink: 0; z-index: 1000; }
        .mode-btn { flex: 1; padding: 10px; border-radius: 20px; border: 2px solid #ddd; cursor: pointer; font-size: 0.85rem; font-weight: bold; text-align: center; transition: 0.3s; background: #f8f9fa; color: #666; }

        /* åœ°å›³ã‚¨ãƒªã‚¢ */
        #map { height: 45vh !important; width: 100%; flex-shrink: 0; z-index: 1; }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #post-form { 
            flex: 1;
            margin: 0; 
            padding: 15px; 
            background: #fff; 
            border-radius: 20px 20px 0 0; 
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 1000;
        }

        textarea { 
            width: 100%; height: 60px; border-radius: 12px; border: 1px solid #eee; 
            padding: 10px; font-size: 16px; box-sizing: border-box; background: #f8fafc;
        }

        /* ä¸¸ã„è‰²ãƒœã‚¿ãƒ³ */
        .color-selector { display: flex; justify-content: center; gap: 15px; margin: 5px 0; }
        .circle-btn { 
            width: 46px; height: 46px; border-radius: 50%; border: 3px solid transparent; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; 
            justify-content: center; font-size: 1.4rem; flex-shrink: 0;
        }
        .circle-btn.selected { border-color: #333; transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        #btn-desc { text-align: center; font-size: 0.85rem; font-weight: bold; min-height: 1.2em; margin-bottom: 5px; }

        #post-button { 
            padding: 14px; color: white; border: none; border-radius: 12px; 
            cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold;
        }

        .file-input-wrapper { text-align: center; margin-bottom: 5px; }
        #image-preview { width: 100%; max-height: 80px; object-fit: cover; display: none; border-radius: 10px; margin-bottom: 5px; }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ¥é…è‰² */
        .c-pale-green { background: #CAFFBF; } .c-pale-blue { background: #A0C4FF; } .c-pale-yellow { background: #FDFFB6; } .c-pale-red { background: #FFADAD; }
        .c-red { background: #FF0000; } .c-yellow { background: #FFD700; } .c-green { background: #32CD32; }

        body.normal-mode .mode-btn.n-active { background: #4dabf7; color: white; border-color: #4dabf7; }
        body.normal-mode #post-button { background: #4dabf7; }
        body.normal-mode .emergency-ui { display: none; }
        
        body.emergency-mode { background-color: #2a0a0a; }
        body.emergency-mode header, body.emergency-mode .mode-switcher { background: #441111; border-color: #552222; color: #fff; }
        body.emergency-mode h1 { color: #fff; }
        body.emergency-mode .mode-btn.e-active { background: #ff0000; color: white; border-color: #ff0000; }
        body.emergency-mode #post-form { background: #441111; color: white; }
        body.emergency-mode textarea { background: #552222; border-color: #663333; color: white; }
        body.emergency-mode #post-button { background: #ff0000; }
        body.emergency-mode .normal-ui { display: none; }
        body.emergency-mode #btn-desc { display: block; color: #ffcccc; }

        /* å¹ãå‡ºã—å†…ã®ç”»åƒã¨ãƒœã‚¿ãƒ³ */
        .iw-img { width: 100%; border-radius: 5px; margin-top: 8px; }
        .hide-btn { margin-top: 10px; padding: 8px; background: #eee; border: none; border-radius: 6px; width: 100%; cursor: pointer; color: #666; font-size: 12px; }
    </style>
</head>
<body class="normal-mode">
    <header><h1 id="title">JORFOR MAP</h1></header>
    <div class="mode-switcher">
        <div id="m-n" class="mode-btn n-active" onclick="switchMode('normal')">é€šå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="m-e" class="mode-btn" onclick="switchMode('emergency')">éå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
    </div>

    <div id="map"></div>

    <form id="post-form">
        <div class="normal-ui">
            <div class="color-selector">
                <div class="circle-btn c-pale-green selected" onclick="pick('pale-green', this, '')"></div>
                <div class="circle-btn c-pale-blue" onclick="pick('pale-blue', this, '')"></div>
                <div class="circle-btn c-pale-yellow" onclick="pick('pale-yellow', this, '')"></div>
                <div class="circle-btn c-pale-red" onclick="pick('pale-red', this, '')"></div>
            </div>
        </div>
        <div class="emergency-ui">
            <div class="color-selector">
                <div class="circle-btn c-red" onclick="pick('red', this, 'ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰')">ğŸš¨</div>
                <div class="circle-btn c-yellow" onclick="pick('yellow', this, 'âš ï¸ è¢«å®³ã‚ã‚Šï¼ˆå»ºç‰©ãƒ»æµ¸æ°´ï¼‰')">âš ï¸</div>
                <div class="circle-btn c-green" onclick="pick('green', this, 'ğŸµ è¢«å®³ãªã—ï¼ˆç„¡äº‹å ±å‘Šï¼‰')">ğŸµ</div>
            </div>
            <div id="btn-desc">ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰</div>
        </div>

        <input type="hidden" id="selected-val" value="pale-green">
        <img id="image-preview">
        <textarea id="post-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
        
        <div class="file-input-wrapper">
            <input type="file" id="image-input" accept="image/*" style="display:none">
            <button type="button" onclick="document.getElementById('image-input').click()" style="background:#eee; border:1px solid #ccc; padding:5px 10px; border-radius:5px; font-size:0.8rem; color:#333;">ğŸ“¸ å†™çœŸã‚’è¿½åŠ </button>
        </div>

        <button type="submit" id="post-button">æŠ•ç¨¿ã™ã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
       
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let hiddenPosts = JSON.parse(localStorage.getItem('joso_hidden_posts') || '[]');
        let map, markers = [];
        let allDocsData = []; 
        let currentMode = 'normal';
        let currentImageData = null;

        // Leafletã®åˆæœŸåŒ–
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.9897, 139.9791], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            load();
        }

        function load() {
            const yesterday = new Date();
            yesterday.setHours(yesterday.getHours() - 24);

            db.collection('posts')
                .where('timestamp', '>=', yesterday)
                .orderBy('timestamp', 'desc')
                .onSnapshot(snap => {
                    allDocsData = [];
                    snap.forEach(doc => { allDocsData.push({ id: doc.id, data: doc.data() }); });
                    renderMarkers();
                }, err => console.error(err));
        }

        function renderMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            const labels = {
                'red': 'ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰',
                'yellow': 'âš ï¸ è¢«å®³ã‚ã‚Šï¼ˆå»ºç‰©ãƒ»æµ¸æ°´ï¼‰',
                'green': 'ğŸµ è¢«å®³ãªã—ï¼ˆç„¡äº‹å ±å‘Šï¼‰'
            };

            allDocsData.forEach(item => {
                const d = item.data;
                const id = item.id;
                const cat = d.category;
                if (hiddenPosts.includes(id) || !d.lat || !d.lng) return;
                if (currentMode === 'emergency' && cat.startsWith('pale-')) return;

                let color = "#A0C4FF";
                switch(cat) {
                    case 'red': color='#ff0000'; break;
                    case 'yellow': color='#ffd700'; break;
                    case 'green': color='#32cd32'; break;
                    case 'pale-red': color='#ffadad'; break;
                    case 'pale-blue': color='#a0c4ff'; break;
                    case 'pale-yellow': color='#fdffb6'; break;
                    case 'pale-green': color='#caffbf'; break;
                }

                // Leafletç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background-color:${color}; width:18px; height:18px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.4);"></div>`,
                    iconSize: [18, 18], iconAnchor: [9, 9]
                });

                const m = L.marker([d.lat, d.lng], { icon: icon }).addTo(map);
                
                let dateObj = d.timestamp ? d.timestamp.toDate() : new Date();
                const time = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const labelHtml = (currentMode === 'emergency' && labels[cat]) 
                    ? `<div style="color:red; font-weight:bold; font-size:14px; margin-bottom:4px;">${labels[cat]}</div>` : '';

                const content = `
                    <div style="color:#333; min-width:160px;">
                        <div style="font-size:10px; color:#777;">${time}</div>
                        ${labelHtml}
                        <div style="font-size:14px; font-weight:bold;">${d.text}</div>
                        ${d.imageUrl ? `<img src="${d.imageUrl}" class="iw-img">` : ''}
                        <button class="hide-btn" onclick="hidePost('${id}')">éè¡¨ç¤ºã«ã™ã‚‹</button>
                    </div>`;

                m.bindPopup(content);
                markers.push(m);
            });
        }

        // --- ä»¥å‰ã®æŠ•ç¨¿ãƒ»åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ ---
        function switchMode(m) {
            currentMode = m; 
            document.body.className = m + '-mode';
            document.getElementById('m-n').classList.toggle('n-active', m==='normal');
            document.getElementById('m-e').classList.toggle('e-active', m==='emergency');
            m === 'normal' ? pick('pale-green', document.querySelector('.normal-ui .circle-btn'), '') : pick('red', document.querySelector('.emergency-ui .circle-btn'), 'ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰');
            renderMarkers();
        }

        function pick(val, el, desc) {
            document.getElementById('selected-val').value = val;
            document.querySelectorAll('.circle-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('btn-desc').innerText = desc;
        }

        function hidePost(id) {
            if (confirm("éè¡¨ç¤ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
                hiddenPosts.push(id);
                localStorage.setItem('joso_hidden_posts', JSON.stringify(hiddenPosts));
                renderMarkers(); 
            }
        }

        document.getElementById('image-input').onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    currentImageData = e.target.result;
                    const p = document.getElementById('image-preview');
                    p.src = currentImageData; p.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('post-form').addEventListener('submit', async e => {
            e.preventDefault();
            const txt = document.getElementById('post-text').value;
            const cat = document.getElementById('selected-val').value;
            if(!txt.trim() && !currentImageData) return;
            const btn = document.getElementById('post-button');
            btn.disabled = true; btn.innerText = "é€ä¿¡ä¸­...";

            navigator.geolocation.getCurrentPosition(p => {
                const loc = {lat: p.coords.latitude, lng: p.coords.longitude};
                db.collection('posts').add({
                    text: txt, category: cat, lat: loc.lat, lng: loc.lng,
                    imageUrl: currentImageData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    document.getElementById('post-text').value = '';
                    document.getElementById('image-preview').style.display = 'none';
                    currentImageData = null;
                    btn.disabled = false; btn.innerText = "æŠ•ç¨¿ã™ã‚‹";
                    map.panTo([loc.lat, loc.lng]);
                });
            }, () => { alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„"); btn.disabled = false; });
        });

        window.onload = initMap;
    </script>
</body>
</html>
